/*
=============================================================
  CYBER HAWK - ESP32 WROOM Flight Controller v4.0
  Compatible with CYBER HAWK Genesis Edition HTML Dashboard
=============================================================

  ENDPOINTS MATCHED TO HTML:
  - /joystick?roll=&pitch=&yaw=&throttle=   ← joystick values -1.0 to 1.0
  - /command?cmd=ARM
  - /command?cmd=DISARM
  - /command?cmd=LED
  - /command?cmd=HOVER
  - /command?cmd=RTH
  - /command?cmd=FLIP_FRONT
  - /command?cmd=FLIP_BACK
  - /command?cmd=HEADLESS_ON
  - /command?cmd=HEADLESS_OFF
  - /status                                  ← connection check (HEAD request)

  MOTOR LAYOUT (top view):
       M1(CW)  M2(CCW)
       M4(CCW) M3(CW)
=============================================================
*/

#include <WiFi.h>
#include <WebServer.h>

// ── WiFi ────────────────────────────────────────────────
const char* ssid     = "CYBER_HAWK";
const char* password = "12345678";

WebServer server(80);

// ── Motor Pins ──────────────────────────────────────────
#define M1      25
#define M2      26
#define M3      27
#define M4      14
#define LED_PIN  2

// ── PWM Config ──────────────────────────────────────────
const int PWM_FREQ       = 5000;
const int PWM_RESOLUTION = 8;      // 0–255

// ── State ───────────────────────────────────────────────
bool armed        = false;
bool hoverMode    = false;
bool headlessMode = false;
bool ledState     = false;

// Joystick values — normalized floats -1.0 to 1.0
float fRoll     = 0;
float fPitch    = 0;
float fYaw      = 0;
float fThrottle = 0;

// ── PWM Setup ───────────────────────────────────────────
void setupPWM() {
  ledcSetup(0, PWM_FREQ, PWM_RESOLUTION);
  ledcSetup(1, PWM_FREQ, PWM_RESOLUTION);
  ledcSetup(2, PWM_FREQ, PWM_RESOLUTION);
  ledcSetup(3, PWM_FREQ, PWM_RESOLUTION);

  ledcAttachPin(M1, 0);
  ledcAttachPin(M2, 1);
  ledcAttachPin(M3, 2);
  ledcAttachPin(M4, 3);
}

// ── Motor Write ─────────────────────────────────────────
void setMotors(int m1, int m2, int m3, int m4) {
  if (!armed) {
    m1 = m2 = m3 = m4 = 0;
  }
  ledcWrite(0, constrain(m1, 0, 255));
  ledcWrite(1, constrain(m2, 0, 255));
  ledcWrite(2, constrain(m3, 0, 255));
  ledcWrite(3, constrain(m4, 0, 255));
}

// ── Mix & Apply ─────────────────────────────────────────
void applyMix() {
  if (!armed || hoverMode) {
    setMotors(0, 0, 0, 0);
    return;
  }

  // Scale normalized values to motor range
  int thr  = (int)(fThrottle * 200) + 55;   // 55–255 range when armed
  int pit  = (int)(fPitch    * 60);
  int rol  = (int)(fRoll     * 60);
  int yaw  = (int)(fYaw      * 40);

  // Standard quadcopter X-frame mixing
  int m1 = thr + pit + rol - yaw;
  int m2 = thr + pit - rol + yaw;
  int m3 = thr - pit + rol + yaw;
  int m4 = thr - pit - rol - yaw;

  setMotors(m1, m2, m3, m4);
}

// ── CORS Headers ────────────────────────────────────────
// Required so browser can reach ESP32 from HTML file
void addCORS() {
  server.sendHeader("Access-Control-Allow-Origin",  "*");
  server.sendHeader("Access-Control-Allow-Methods", "GET, HEAD, OPTIONS");
  server.sendHeader("Access-Control-Allow-Headers", "*");
}

// ── /status  (HEAD request for connection check) ────────
void handleStatus() {
  addCORS();
  server.send(200, "text/plain", "OK");
}

// ── /joystick ───────────────────────────────────────────
// HTML sends: /joystick?roll=X&pitch=X  or  ?yaw=X&throttle=X
void handleJoystick() {
  addCORS();

  if (server.hasArg("roll"))     fRoll     = server.arg("roll").toFloat();
  if (server.hasArg("pitch"))    fPitch    = server.arg("pitch").toFloat();
  if (server.hasArg("yaw"))      fYaw      = server.arg("yaw").toFloat();
  if (server.hasArg("throttle")) fThrottle = server.arg("throttle").toFloat();

  // Clamp all values to -1.0 … 1.0
  fRoll     = constrain(fRoll,     -1.0, 1.0);
  fPitch    = constrain(fPitch,    -1.0, 1.0);
  fYaw      = constrain(fYaw,      -1.0, 1.0);
  fThrottle = constrain(fThrottle, -1.0, 1.0);

  applyMix();
  server.send(200, "text/plain", "OK");
}

// ── /command ────────────────────────────────────────────
void handleCommand() {
  addCORS();
  String cmd = server.arg("cmd");

  if (cmd == "ARM") {
    armed = true;
    Serial.println("ARMED");
  }
  else if (cmd == "DISARM") {
    armed = false;
    fRoll = fPitch = fYaw = fThrottle = 0;
    setMotors(0, 0, 0, 0);
    Serial.println("DISARMED");
  }
  else if (cmd == "LED") {
    // HTML sends single LED command — toggle on each press
    ledState = !ledState;
    digitalWrite(LED_PIN, ledState ? HIGH : LOW);
    Serial.println(ledState ? "LED ON" : "LED OFF");
  }
  else if (cmd == "HOVER") {
    hoverMode = !hoverMode;
    if (hoverMode) {
      fRoll = fPitch = fYaw = fThrottle = 0;
      setMotors(0, 0, 0, 0);
    }
    Serial.println(hoverMode ? "HOVER ON" : "HOVER OFF");
  }
  else if (cmd == "RTH") {
    // Return to home — cut throttle gradually, disarm on land
    // Basic implementation: disarm motors
    armed = false;
    fRoll = fPitch = fYaw = fThrottle = 0;
    setMotors(0, 0, 0, 0);
    Serial.println("RTH TRIGGERED");
  }
  else if (cmd == "FLIP_FRONT") {
    // Send brief forward pitch pulse
    if (armed) {
      setMotors(200, 200, 50, 50);
      delay(300);
      applyMix();
    }
    Serial.println("FLIP FRONT");
  }
  else if (cmd == "FLIP_BACK") {
    // Send brief reverse pitch pulse
    if (armed) {
      setMotors(50, 50, 200, 200);
      delay(300);
      applyMix();
    }
    Serial.println("FLIP BACK");
  }
  else if (cmd == "HEADLESS_ON") {
    headlessMode = true;
    Serial.println("HEADLESS ON");
  }
  else if (cmd == "HEADLESS_OFF") {
    headlessMode = false;
    Serial.println("HEADLESS OFF");
  }

  server.send(200, "text/plain", "CMD_OK");
}

// ── /options (preflight CORS) ───────────────────────────
void handleOptions() {
  addCORS();
  server.send(204);
}

// ── Setup ───────────────────────────────────────────────
void setup() {
  Serial.begin(115200);
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  setupPWM();
  setMotors(0, 0, 0, 0);

  WiFi.softAP(ssid, password);
  Serial.print("AP IP: ");
  Serial.println(WiFi.softAPIP());

  server.on("/status",   HTTP_GET,  handleStatus);
  server.on("/status",   HTTP_HEAD, handleStatus);
  server.on("/joystick", HTTP_GET,  handleJoystick);
  server.on("/command",  HTTP_GET,  handleCommand);

  // Handle CORS preflight for all routes
  server.onNotFound([](){
    if (server.method() == HTTP_OPTIONS) {
      handleOptions();
    } else {
      server.send(404, "text/plain", "Not Found");
    }
  });

  server.begin();
  Serial.println("CYBER HAWK Flight Controller Ready");
}

// ── Loop ────────────────────────────────────────────────
void loop() {
  server.handleClient();
}
