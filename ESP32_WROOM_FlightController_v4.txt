/*
=================================================
 CYBER HAWK v6 â€“ Advanced Stabilized Edition
 Auto Calibration + Smart Flip + Yaw PID
=================================================
*/

#include <Wire.h>
#include <MPU6050.h>

MPU6050 mpu;

#define RXD2 16
#define TXD2 17

#define M1 25
#define M2 26
#define M3 27
#define M4 14
#define LED_PIN 2

const int PWM_FREQ = 20000;
const int PWM_RES = 8;

bool armed = false;
bool hoverMode = false;
bool flipActive = false;

float fRoll=0, fPitch=0, fYaw=0, fThrottle=0;

float roll=0, pitch=0, yawRate=0;
float rollSet=0, pitchSet=0, yawSet=0;

float gyroXoff=0, gyroYoff=0, gyroZoff=0;

float kp=3.5, ki=0.02, kd=1.8;
float yawKp=2.0;

float rSum=0, pSum=0;
float rPrev=0, pPrev=0;

float hoverThrottle=0;

unsigned long lastTime;

void setupPWM(){
  ledcSetup(0,PWM_FREQ,PWM_RES);
  ledcSetup(1,PWM_FREQ,PWM_RES);
  ledcSetup(2,PWM_FREQ,PWM_RES);
  ledcSetup(3,PWM_FREQ,PWM_RES);
  ledcAttachPin(M1,0);
  ledcAttachPin(M2,1);
  ledcAttachPin(M3,2);
  ledcAttachPin(M4,3);
}

void setMotors(int a,int b,int c,int d){
  if(!armed) a=b=c=d=0;
  ledcWrite(0,constrain(a,0,255));
  ledcWrite(1,constrain(b,0,255));
  ledcWrite(2,constrain(c,0,255));
  ledcWrite(3,constrain(d,0,255));
}

void calibrateMPU(){
  Serial.println("CALIBRATING...");
  for(int i=0;i<1000;i++){
    int16_t ax,ay,az,gx,gy,gz;
    mpu.getMotion6(&ax,&ay,&az,&gx,&gy,&gz);
    gyroXoff+=gx;
    gyroYoff+=gy;
    gyroZoff+=gz;
    delay(3);
  }
  gyroXoff/=1000;
  gyroYoff/=1000;
  gyroZoff/=1000;
  Serial.println("CALIBRATION DONE");
}

void readMPU(){
  int16_t ax,ay,az,gx,gy,gz;
  mpu.getMotion6(&ax,&ay,&az,&gx,&gy,&gz);

  gx-=gyroXoff;
  gy-=gyroYoff;
  gz-=gyroZoff;

  float accelRoll=atan2(ay,az)*57.3;
  float accelPitch=atan2(-ax,sqrt(ay*ay+az*az))*57.3;

  float dt=(millis()-lastTime)/1000.0;
  lastTime=millis();

  roll=0.98*(roll+(gx/131.0)*dt)+0.02*accelRoll;
  pitch=0.98*(pitch+(gy/131.0)*dt)+0.02*accelPitch;
  yawRate=gz/131.0;
}

float pid(float set,float cur,float &sum,float &prev){
  float err=set-cur;
  sum+=err;
  float d=err-prev;
  prev=err;
  return kp*err+ki*sum+kd*d;
}

void applyControl(){
  if(flipActive) return;

  float rCorr=pid(rollSet,roll,rSum,rPrev);
  float pCorr=pid(pitchSet,pitch,pSum,pPrev);
  float yCorr=yawKp*(yawSet-yawRate);

  int base=hoverMode?hoverThrottle:(int)(fThrottle*200)+55;

  int m1=base+pCorr+rCorr-yCorr;
  int m2=base+pCorr-rCorr+yCorr;
  int m3=base-pCorr+rCorr+yCorr;
  int m4=base-pCorr-rCorr-yCorr;

  setMotors(m1,m2,m3,m4);
}

void smartFlip(bool front){
  if(!armed) return;
  if(fThrottle < 0.65) return;   // require strong throttle
  if(flipActive) return;

  flipActive = true;

  unsigned long flipStart = millis();
  int flipPower = 200;

  while(millis() - flipStart < 450){   // controlled flip duration

    readMPU();

    int base = (int)(fThrottle * 200) + 55;

    int m1,m2,m3,m4;

    if(front){
      // Front flip (Pitch axis)
      m1 = base + flipPower;
      m2 = base + flipPower;
      m3 = base - flipPower;
      m4 = base - flipPower;
    } else {
      // Back flip (Roll axis)
      m1 = base + flipPower;
      m2 = base - flipPower;
      m3 = base + flipPower;
      m4 = base - flipPower;
    }

    setMotors(m1,m2,m3,m4);
  }

  // STOP flip burst
  setMotors(0,0,0,0);
  delay(50);

  flipActive = false;

  // Reset PID memory to prevent violent correction
  rSum = 0;
  pSum = 0;
  rPrev = 0;
  pPrev = 0;
}

void parseJoystick(String s){
  int i=s.indexOf(':');
  String v=s.substring(i+1);
  int p1=v.indexOf(',');
  int p2=v.indexOf(',',p1+1);
  int p3=v.indexOf(',',p2+1);

  fThrottle=v.substring(0,p1).toFloat()/255.0;
  fPitch=v.substring(p1+1,p2).toFloat()/100.0;
  fRoll=v.substring(p2+1,p3).toFloat()/100.0;
  fYaw=v.substring(p3+1).toFloat()/100.0;

  if(!hoverMode){
    rollSet=fRoll*15;
    pitchSet=fPitch*15;
  }

  yawSet=fYaw*50;
}

void parseCommand(String c){
  c.replace("CMD:","");
  if(c=="ARM") armed=true;
  else if(c=="DISARM"){armed=false;setMotors(0,0,0,0);}
  else if(c=="HOVER"){
    hoverMode=!hoverMode;
    hoverThrottle=(int)(fThrottle*200)+55;
    rollSet=0; pitchSet=0;
  }
  else if(c=="FLIP_FRONT") smartFlip(true);
  else if(c=="FLIP_BACK") smartFlip(false);
  else if(c=="LED") digitalWrite(LED_PIN,!digitalRead(LED_PIN));
}

void setup(){
  Serial.begin(115200);
  Serial2.begin(115200,SERIAL_8N1,RXD2,TXD2);

  Wire.begin(21,22);
  mpu.initialize();
  delay(1000);
  calibrateMPU();

  pinMode(LED_PIN,OUTPUT);
  setupPWM();
  lastTime=millis();
}

void loop(){
  readMPU();

  if(Serial2.available()){
    String d=Serial2.readStringUntil('\n');
    if(d.startsWith("J:")) parseJoystick(d);
    if(d.startsWith("CMD:")) parseCommand(d);
  }

  if(armed) applyControl();
}
